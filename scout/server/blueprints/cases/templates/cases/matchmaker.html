{% extends "layout.html" %}

{% block title %}
  {{ super() }} - {{ institute.display_name }} - {{ case.display_name }}
{% endblock %}

{% block css %}
{{ super() }}
<style>
.even {
   background: #d1d5db;
}
.accordion .card {
  margin-bottom: 5px;
}
.table-bordered td, .table-bordered th {
  padding: 8px 5px; /* Less padding */
}
.accordion .btn {
  font-size: 1rem; /* Reduce button text size */
}
.match-summary {
  display: flex;
  flex-wrap: wrap;
}
.match-summary div {
  flex: 1; /* Distribute evenly */
  margin-right: 10px;
}
.badge {
  font-size: 0.9rem; /* Reduce badge size */
}
.gene-info {
  margin-left: 10px;
  display: flex;
  flex-wrap: wrap;
}
.gene-info ul {
  margin: 5px;
}
</style>
{% endblock %}

{% block top_nav %}
  {{ super() }}
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('cases.index') }}">Institutes</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('overview.cases', institute_id=institute._id) }}">
      {{ institute.display_name }}
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('cases.case', institute_id=institute._id, case_name=case.display_name ) }}">
      {{ case.display_name }}
    </a>
  </li>
  <li class="nav-item d-flex align-items-center active">
    <span class="navbar-text">Matchmaker</span>
  </li>
{% endblock %}

{% block content_main %}
{% set panel = panel or 1|int %}
<div class="container-float">
  <div class="card">
    <div class="card-body">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">Submitted: <strong>{{case.mme_submission.created_at.strftime('%Y-%m-%d %H:%M')}}</strong></li>
          <li class="breadcrumb-item">Last updated: <strong>{{case.mme_submission.updated_at.strftime('%Y-%m-%d %H:%M')}}</strong></li>
        </ol>
      </nav>
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item"><a href="#" class="nav-link {% if panel == 1 %}active{% endif %}" data-bs-toggle="tab" onclick="hide_div(1)"><h4>Patient overview <i class="fa fa-id-card" aria-hidden="true"></i></h4></a></li>
        <li class="nav-item"><a href="#" class="nav-link {% if panel == 2 %}active{% endif %}" data-bs-toggle="tab" onclick="hide_div(2)"><h4>Global matches <i class="fa fa-globe" aria-hidden="true"></i></h4></a></li>
        <li class="nav-item"><a href="#" class="nav-link {% if panel == 3 %}active{% endif %}" data-bs-toggle="tab" onclick="hide_div(3)"><h4>Local matches <i class="fa fa-hospital" aria-hidden="true"></i></h4></a></li>
      </ul>
      <div class="tab-content" id="tabs">
        <div class="tab-pane" id="1">
          {{ patient_data() }}
        </div>
        <div class="tab-pane" id="2">
          {{ show_matches('external') }}
        </div>
        <div class="tab-pane" id="3">
          {{ show_matches('internal') }}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% macro patient_data() %}
  {% for patient in case.mme_submission.patients %}
  <div class="row mt-3 {{ loop.cycle('odd', 'even') }}">
    <div class="col-2.5"> <!-- Patient general info -->
      <div class="card-body">
        <div class="card-title pb-1 pt-1 bg-secondary text-white">Patient #{{loop.index}}</div>
        <ul class="list-group">
          <li class="list-group-item" style="">Patient id: <strong>{{patient.id}}</strong></li>
          <li class="list-group-item">Patient label: <strong>{{patient.label}}</strong></li>
          <li class="list-group-item">Gender: <strong>{{patient.sex or "n.a."}}</strong></li>
        </ul>
      </div>
    </div> <!-- End of patient's general info -->

    <div class="col-3"> <!-- Phenotypes (HPO and OMIM) -->
      <div class="card-body">
        <div class="card-title pb-1 pt-1 bg-secondary text-white">Phenotype features (HPO terms)</div>
        <ul class="list-group list-group-flush">
          {% for hpo in case.mme_submission.features %}
            <li class="list-group-item">
              <a class="text-white" target="_blank" href="http://hpo.jax.org/app/browse/term/{{hpo.id}}">
              <span class="badge bg-sm bg-info">{{hpo.id}}</span>
              </a>{{hpo.label}}
            </li>
          {% endfor %}
        </ul>

        <div class="card-title pb-1 pt-1 bg-secondary text-white mt-3">Diagnoses (OMIM terms)</div>
        <ul class="list-group list-group-flush">
          {% for omim in case.mme_submission.disorders %}
            <li class="list-group-item">
              <a class="text-white" target="_blank" href="http://omim.org/entry/{{omim.id[4:]}}">
              <span class="badge bg-sm bg-secondary">{{omim.id}}</span>
              </a>{{omim.label}}
            </li>
          {% endfor %}
        </ul>
      </div>
    </div> <!-- End of phenotypes (HPO and OMIM) -->

    <div class="col-6"> <!-- Gene & variants -->
      <div class="row">
        {% for g_feat in patient.genomicFeatures %}
          <div class="card col-4 mt-3 mb-3">
            <ul class="list-group list-group-flush">
              {% for key, value in g_feat.items() %}
                <li class="list-group-item">
                  {% if key == 'gene' %}
                    <div class="card-title pb-1 pt-1 bg-dark text-white">Gene:{{value.id}}</div>
                  {% elif key == 'variant' %}
                    {% for ikey, item in value.items() %}
                      {{ikey}}:<strong>{{item}}</strong><br>
                    {% endfor %}
                  {% elif key == 'type' %} <!-- this will be variant effect -->
                    {{key}}:<strong>{{value.label}}</strong>
                  {% else %} <!-- this will be zygosity -->
                    {{key}}:<strong>{{value}}</strong>
                    {% if value == 1 %}
                      (heteroz. or hemiz. if on X in males)
                    {% elif value == 2 %}
                      (homozygous)
                    {% endif %}
                  {% endif %}
                </li>
              {% endfor %} <!-- End of for key, value in g_feat.items() -->
            </ul>
          </div> <!-- End of g_feat card -->
        {% endfor %} <!-- End of for g_feat in patient.genomicFeatures -->
      </div>
    </div> <!-- End of genes and variants -->
  </div> <!-- End of patient row -->
  <br><br>
  {% endfor %} <!-- End of for patient in case.mme_submission.patients loop -->
{% endmacro %}

{% macro show_matches(type) %}
<!-- show matches of the selected type from the most recent -->
<div class="m-3 mt-3">
  {% set matching_patients = [] %}
  {% for patient, match_objs in matches.items() %}
    <h4> Showing {{type}} matches for patient {{ patient.split('.')[1] }}:</h4>
    {% for match_obj in match_objs if match_obj.match_type == type %}
      {% do matching_patients.append(match_obj.patient_id) %}
      <div class="accordion" id="accordionExample">
        <div class="card">
          <div class="card-header">
            <button class="btn btn-link collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#div_{{match_obj.match_oid}}">
              Match {{match_obj.match_date.strftime('%Y-%m-%d %H:%M')}}
              {% if match_obj.patients %}
                <span class="badge rounded-pill bg-success">{{match_obj.patients|length}} matches</span>
              {% else %}
                No matches available
              {% endif %}
            </button>
          </div>
          <div id="div_{{match_obj.match_oid}}" class="collapse">
            <div class="card-body">
              <div class="match-summary">
                <div>Score: <span class="badge bg-primary">{{match_obj.score.patient | round(4)}}</span></div>
                <div>Node: <strong>{{ match_obj.node.label }}</strong></div>
                <div>ID: <strong>{{ match_obj.patient_id }}</strong></div>
                <div>Contact: {{ match_obj.patient.contact.name }}</div>
              </div>
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th>Phenotypes</th>
                    <th>Diagnoses</th>
                    <th>Gene/Variants</th>
                  </tr>
                </thead>
                <tbody>
                  {% for match_result in match_obj.patients %}
                    <tr>
                      <td>
                        {% for feature in match_result.patient.features %}
                          <span class="badge bg-info">{{feature.label}} ({{feature.id}})</span>
                        {% endfor %}
                      </td>
                      <td>
                        {% for omim in match_result.patient.disorders %}
                          <a href="http://omim.org/entry/{{omim.id[4:]}}" target="_blank">{{omim.id}}</a>
                        {% endfor %}
                      </td>
                      <td class="gene-info">
                        {% for g_feat in match_result.patient.genomicFeatures %}
                          <ul>
                            <li><strong>{{ g_feat.gene._geneName }}</strong></li>
                            <li>Variant: {{ g_feat.variant or '-' }}</li>
                          </ul>
                        {% endfor %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
    {% if not matching_patients %}
      No matches available for this patient.
    {% endif %}
  {% endfor %}
</div>
{% endmacro %}

{% block scripts %}
  {{ super() }}
  <script type="text/javascript">
    $(document).ready(function() {
      hide_div({{panel}})
    });

    function hide_div(show_div){
      for (i=1; i<4; i++) {
        var div_el = document.getElementById(i);
        if (i==show_div){ //show div
          div_el.style.display = "block";
        }
        else{ //hide other divs
          div_el.style.display = "none";
        }
      }
    };
  </script>
{% endblock %}
