{% extends "layout_bs4.html" %}

{% block title %}
  {{ super() }} - {{ institute_id }}
{% endblock %}

{% block top_nav %}
  {{ super() }}
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('cases.index') }}">Institutes</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('cases.cases', institute_id=institute_id) }}">
      {{ institute_id }} Cases
    </a>
  </li>
  {% if config.SHOW_CAUSATIVES %}
    <li class="nav-item">
      <a class="nav-link" href="{{ url_for('cases.causatives', institute_id=institute_id) }}">Causatives</a>
    </li>
   {% endif %}
    <li class="nav-item">
      <a class="nav-link" href="{{ url_for('cases.gene_variants', institute_id=institute_id, variant_type=['clinical'], rank_score=15) }}">All SNVs and INDELs</a>
    </li>
  <li class="nav-item active">
    <span class="navbar-text">Clinvar submissions</span>
  </li>
{% endblock %}

{% block content_main %}
<div class="container-float">
  <h3>Clinvar submissions page<h5></h3><a data-target="#howto" href="#" data-toggle="modal">howto</a></h5><br>
  <!-- Modal -->
  <div class="modal fade w-100" role="dialog" id="howto" aria-hidden="true" tabindex="-1">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-body">
          <h5>Requirements</h5>
          <p>
            Make sure to <strong>register a user</strong> to the <a href="https://www.ncbi.nlm.nih.gov/clinvar/docs/submission_portal/" target="_blank">clinVar submission portal.</a><br>
                        If your organization is not already present in clinVar you should follow the instructions to <strong>register a submitting organization</strong> to the same portal.
                        The first time an organization is registered in the ClinVar Submission Portal, the content will be reviewed, so it will take some time before getting approved in order to start a variant submission.
          </p><br>
          <h5>Obtain a submission ID</h5>
          <p>
            If the requirements above are fullfilled, you can start a new submission by using the "<strong>Upload new file submission</strong>" button from the <a href="https://submit.ncbi.nlm.nih.gov/clinvar/" target="_blank">submission page</a>.<br>This button is a link to a multi-panel (4 panels) submission page. The first panel (submission information) has a precompiled field named "<strong>Submission name</strong>".
          </p><br>
          <h5>Fill in panel 1 and 2</h5>
          <p>
            Fill in submission forms in panel 1 and 2, respectively named "Submission information" and "Organization". In the "<strong>Submission format</strong>" in panel 1 make sure to select the value "<strong>Comma-separated values</strong>".<br>
            <strong>Assemby name</strong> fields should be filled in before proceding further with the submission.
          </p><br>
          <h5>Download the files</h5>
          <p>
            You'll need to register the <strong>Submission Name</strong> obtained from Clinvar portal in order to download variants and casedata submission files.
          </p><br>
          <h5>Upload the files to Clinvar</h5>
          <p>
            Upload the files obtained above (either the variants .csv file or the variants .csv + the casedata .csv files) in the "<strong>Submission Files</strong>" field in the third panel of the submission.
          The field named <strong>"Assertion Criteria File" should be left blank</strong>, since the default information is already filled in the "Variants sheet" <strong>(ACMG Guidelines, 2015)</strong>.
          </p>
        </div>
        <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
      </div>
    </div>
  </div>
  <!-- Modal end -->
  <br>
  {% if submissions %}
    {% for submission in submissions|sort(attribute='status', reverse=True) %}
      {{ submission_panel(submission) }}
    {% endfor %}
  {% else %}
  <p>No clinvar submission was found. You can create one by clicking on "Submit to Clinvar" from the page of a pinned variant.</p>
  {% endif %}
</div>
{% endblock %}

{% macro submission_panel(subm_obj) %}
<form class="form-inline" id="submission_form" action="{{ url_for('cases.clinvar_submissions', institute_id=institute_id) }}" method="POST">
    <input type="hidden" name="submission_id" value="{{subm_obj._id}}">
    <div class="card w-100">
      <div class="card-header {{ 'bg-primary' if subm_obj.status=='open' else 'bg-warning' }}">
        Submission <strong>{{subm_obj._id}} - ({{subm_obj.status|upper}})</strong> / Created: <strong>{{subm_obj.created_at.strftime('%Y-%m-%d')}}</strong> / Last updated: <strong>{{subm_obj.updated_at.strftime('%Y-%m-%d')}}</strong>
      </div><!-- end of card header-->
      <div class="card-body">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb align-items-center" >
            <li class="breadcrumb-item"><button type="submit" name="csv_type" value="variant_data" class="btn btn-primary btn-xs">Download variants file</button>&nbsp;<button name="csv_type" value="case_data" type="submit" class="btn btn-primary btn-xs">Download casedata file</button></li>
            {% if subm_obj.status=='open'%}
              <li class="breadcrumb-item"><button type="submit" name="update_submission" value="close" class="btn btn-warning btn-xs">Close submission</button></li>
            {% else %}
              <li class="breadcrumb-item"><button type="submit" name="update_submission" value="open" class="btn btn-success btn-xs">Re-open submission</button></li>
            {% endif %}
            <li class="breadcrumb-item"><button type="submit" name="update_submission" value="delete" class="btn btn-danger btn-xs">Delete submission</button></li>
          </ol>
        </nav>
        <div class="form-group">
          <label for="clinvar_id">submission name</label>
          <input type="text" class="form-control mx-sm-3" name="clinvar_id" pattern="SUB[0-9]+" placeholder="ex: SUB1234567" value="{{ subm_obj.clinvar_subm_id }}">
          <button type="submit" class="btn btn-primary" name="update_submission" value="register_id">Update</button>
        </div>
      </div><!-- end of card body-->
    </div><!-- end of card -->
</form>
{% endmacro %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
<script type="text/javascript">
$(function () {
    $('.casedata  div').hide();

    $('.vardata  div').hide();

    $('.cd_btn').on('click', function(){
        var bid = $(this)[0].id;
        var sel = '#cddiv' + bid;
        if($(sel).is(':visible')){
          $(sel).hide();
        }
        else{
          $('.casedata  div').hide();
          $(sel).fadeToggle();
        }
    });

    $('.var_btn').on('click', function(){
        var bid = $(this)[0].id;
        var sel = '#vardiv' + bid;
        if($(sel).is(':visible')){
          $(sel).hide();
        }
        else{
          $('.vardata  div').hide();
          $(sel).fadeToggle();
        }
    });
});


</script>

{% endblock %}
