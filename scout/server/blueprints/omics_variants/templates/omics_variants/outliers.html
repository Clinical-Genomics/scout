{% extends "layout.html" %}

{% import "bootstrap/wtf.html" as wtf %}

{% from "variants/components.html" import external_scripts, external_stylesheets, gene_cell %}
{% from "variant/buttons.html" import splice_junctions_button %}
{% from "variants/utils.html" import filter_script_main, pagination_footer, pagination_hidden_div, stash_filter_buttons, update_stash_filter_button_status%}

{% block title %}
  {{ super() }} - {{ institute.display_name }} - {{ case.display_name }} - {{ form.variant_type.data|capitalize }} omics outlier variants
{% endblock %}

{% block css %}
  {{ super() }}
  {{ external_stylesheets() }}
{% endblock %}

{% block top_nav %}
  {{ super() }}
  <li class="nav-item">
    <a class="nav-link text-nowrap" href="{{ url_for('cases.index') }}">Institutes</a>
  </li>
  <li class="nav-item">
    <a class="nav-link text-nowrap" href="{{ url_for('overview.cases', institute_id=institute._id) }}">
      {{ institute.display_name }}
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link text-nowrap" href="{{ url_for('cases.case', institute_id=institute._id, case_name=case.display_name) }}">
      {{ case.display_name }}
    </a>
  </li>
  <li class="nav-item active d-flex align-items-center">
    <span class="navbar-text">{{ form.variant_type.data|capitalize }} WTS outliers</span>
  </li>
{% endblock %}

{% block content_main %}
  <div class="container-float">
    <form method="POST" id="filters_form" action="{{url_for('omics_variants.outliers', institute_id=institute._id, case_name=case.display_name)}}"
        enctype="multipart/form-data" onsubmit="return validateForm()">

      {{ pagination_hidden_div(page) }}
      <div class="card panel-default" id="accordion">
        <div class="card-header">
          <strong><a data-bs-toggle="collapse" data-parent="#accordion" href="#collapseFilters">Filters</a></strong>
        </div>
        <!--Expand filters form if filters were used in a previous POST request-->
        <div class="card-body panel-collapse collapse {{ 'show' if expand_search is sameas true }}" id="collapseFilters">
            {{ outlier_filters(form, institute, case) }}
        </div>
        {{ omics_filter_form_footer(form, result_size, total_variants, more_variants, page, variants|length, institute) }}
      </div>
    </form>
    <div class="card mt-3">
      <table class="table table-hover table-bordered" style="table-layout: fixed">
        <thead class="thead table-light">
              <tr>
                <th title="Variant display name">Outlier</th>
                <th style="width:10%" title="Sub-category">Type</th>
                <th title="HGNC symbols">Gene</th>
                <th title="Functional annotation">Func. annotation</th>
                <th style="width:5%" title="Value - delta Psi or l2fc ">Value</th>
                <th style="width:5%" title="P-value">P-value</th>
                <th title="Individual">Ind</th>
                <th style="width:3%" title="Chromosome">Chr</th>
                <th title="Position">Pos</th>
              </tr>
        </thead>
          <tbody>
            {% for variant in variants %}
              <tr>
              <td>{{ variant.display_name|truncate(36,True) }}</td>
              <td>{{ variant.sub_category }}</td>
              <td>
                {% if variant.genes %}
                  {{ gene_cell(variant) }}
                {% else %}
                  {{ variant.gene_name_orig }}
                {% endif %}
              </td>
              <td>
                {%  if variant.sub_category == "splicing" %}
                  {{ variant.potentialImpact }} - fs {{ variant.causesFrameshift }}
                {% endif %}
              </td>
              <td class="text-end"> {%  if variant.sub_category == "splicing" %}
                  {{ variant.deltaPsi }}
                {% else %}
                  {{ variant.l2fc }}
                {% endif %}
              </td>
              <td class="text-end">{{ '%.3e' % variant.pValue }}</td>
              <td>{{ case.individuals.0.display_name }}</td>
              <td class="text-end">{{ variant.chromosome }}</td>
                <td class="text-end"><span style="white-space: nowrap;">{{ variant.start|human_longint|safe }}</span>-<span style="white-space: nowrap;">{{ variant.end|human_longint|safe }}</span>
                {% if case.bam_files %}
                  <a class="btn btn-secondary btn-sm text-white" href="{{url_for('alignviewers.igv', institute_id=institute['_id'], case_name=case['display_name'], variant_id=variant['omics_variant_id'], chrom=variant['chromosome'], start=variant['start'], end=variant['end'])}}"
                     rel="noopener" target="_blank">IGV viewer</a>
                {% else %}
                  <button title="BAM file(s) missing" class="btn btn-secondary btn-sm" disabled>IGV viewer</button>
                {% endif %}
                {% if case.has_rna_tracks %}
                  {{ splice_junctions_button(institute._id, case.display_name) }}
                {% endif %}
              </tr>
            {% else %}
              <tr>
                <td colspan="9">
                  No matching variants
                </td>
              </tr>
            {% endfor %}
         </tbody>
       </table>
     </div><!-- end of <div class="card mt-3">-->
    </div> <!-- end of class="container-float"> -->
  </form> <!--end of form containing filters and variants' table elements -->
  <div class="container-fluid" style="padding-bottom: 100px">
    {{ pagination_footer(more_variants, page) }}
  </div>

{% endblock %}

{% block scripts %}
  {{ super() }}
  {{ external_scripts() }}
  <script src="{{ url_for('variants.static', filename='form_scripts.js') }}"></script>
  {{ filter_script_main(cytobands) }}
  <script type="text/javascript">
    window.onload=function() {
      populateCytobands({{cytobands|safe}});
      {{ update_stash_filter_button_status(current_user, filters) }}
    }

    $("#filters").change(function () {
      {{ update_stash_filter_button_status(current_user, filters) }}
    });

    $('select[multiple]').selectpicker({
      width: '100%'
    });

    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
    return new bootstrap.Popover(popoverTriggerEl, {
        sanitizeFn: function (content) {
          return DOMPurify.sanitize(content)
        },
        container: 'body',
      })
    })

  </script>

{% endblock %}

{% macro outlier_filters(form, institute, case, filters) %}
<input type="hidden" name="variant_type" value="{{ form.variant_type.data }}">
<div class="row">
  <div class="col-2">
    <span>{{ form.gene_panels.label(class="control-label", data_bs_toggle="tooltip", data_bs_placement="left", title="This list can be modified from the institute settings page. Latest panel version is used in variants filtering.") }}</span>
    <span style="float:right;">{{ form.gene_panels_exclude.label(class="control-label", data_bs_toggle="tooltip", data_bs_placement="left", title="Check this box to exclude from the search any gene listed in selected 'Gene Panels', 'Symbol file' or provided in the 'HGNC Symbols/Ids' field.") }} {{form.gene_panels_exclude}}</span>
    {{ form.gene_panels(class="selectpicker", data_style="btn-secondary") }}
  </div>
  <div class="col-3">
    {{ form.hgnc_symbols.label(class="control-label") }}
    {{ form.hgnc_symbols(class="form-control") }}
  </div>
  <div class="col-1 align-self-end">
    <div class="btn-group d-flex">
      <a class="btn btn-secondary text-white" href="{{ url_for('omics_variants.outliers', institute_id=institute._id,
        case_name=case.display_name, variant_type=form.variant_type.data,
        gene_panels=['hpo']) }}">HPO gene list</a>
    </div>
  </div>
</div>
<div class="row">
  <div class="col-2">
    {{ form.chrom.label(class="control-label") }}
    {{ form.chrom(class="selectpicker", data_style="btn-secondary", data_actions_box="true") }}
  </div>
  <div class="col-2">
    {{ wtf.form_field(form.start) }}
  </div>
  <div class="col-2">
    {{ wtf.form_field(form.end) }}
  </div>
  <div class="col-2">
    {{ wtf.form_field(form.cytoband_start) }}
  </div>
  <div class="col-2">
    {{ wtf.form_field(form.cytoband_end) }}
  </div>
</div>
<div class="row" style="margin-top:20px;">
    <div class="col-4">
      {{ form.filter_variants(class="btn btn-primary form-control", onclick="resetPage()") }}
    </div>
    <div class="col-4">
      {{ form.clinical_filter(class="btn btn-secondary form-control", onclick="resetPage()") }}
    </div>
    <div class="col-4">
      {{ form.export(class="btn btn-warning form-control") }}
    </div>
</div>
<div class="row" style="margin-top:20px;">
  <div class="col-2 text-start">
    <a href="{{ url_for('omics_variants.outliers', institute_id=institute._id, case_name=case.display_name,
      variant_type=form.variant_type.data) }}"
      class="btn btn-secondary" style="color: #ffffff !important;">
      Reset&nbsp;filters
    </a>
  </div>
  <div class="col-6">
    {{ stash_filter_buttons(form, institute, case) }}
  </div>
</div>
{% endmacro %}

{% macro omics_filter_form_footer(form, result_size, total_variants, more_variants, page, nvars, institute) %}
<div class="card-footer text-center">
  <div class="row">
    <div class="col-4">
      <div class="form-check d-flex justify-content-start">
        {% if institute.check_show_all_vars %}
          <input type="checkbox" class="form-check-input" name="show_unaffected" id="show_unaffected" checked disabled>
          {{ form.show_unaffected.label(class="form-check-label ms-2", **{'data-bs-toggle': 'tooltip', 'title':'Modify general institute settings to be able to edit this checkbox'}) }}
        {% else %}
          {{ form.show_unaffected(class="form-check-input") }}
          {{ form.show_unaffected.label(class="form-check-label ms-2", **{'data-bs-toggle': 'tooltip', 'title':'This filter applies only to cases with more than one sample. When this is unchecked, only variants that are predicted by callers to be present in an affected individual genotype are shown.'}) }}
        {% endif %}
      </div>
    </div>
    <div class="col-4 d-flex justify-content-center">
      Filter returns {{result_size}} / {{ total_variants }} variants.
    </div>
    <div class="col-4 d-flex flex-column justify-content-end">
      <div class="d-flex justify-content-end">Showing {%if more_variants %}page {{page}}{%else%}last page{% endif %} with {{nvars}} variants.</div>
    </div>
  </div>
</div>
{% endmacro %}
