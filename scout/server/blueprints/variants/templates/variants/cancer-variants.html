{% extends "variants/variants_layout.html" %}
{% from "utils.html" import clickable_table_row_script %}
{% from "variants/components.html" import allele_cell, external_scripts, external_stylesheets, gene_cell, frequency_cell_general, observed_cell_general, variant_funct_anno_cell %}
{% from "variants/utils.html" import callers_cell, cancer_filters, cell_rank, dismiss_variants_block, enable_variants_hotkeys, filter_form_footer, filters_form_header, filter_script_main, pagination_footer, pagination_hidden_div, update_stash_filter_button_status, variant_link_href, variant_rank_score %}
{% from "variants/indicators.html" import pin_indicator, causative_badge, clinical_assessments_badge, comments_badge, dismissals_badge, evaluations_badge, group_assessments_badge, matching_manual_rank, other_tiered_variants, other_escat_tiered_variants, research_assessments_badge %}

{% block category_title %}
  somatic variants
{% endblock %}

{% block variants_form_action %}
  {{url_for('variants.cancer_variants', institute_id=institute._id, case_name=case.display_name)}}
{% endblock %}

{% block variants_filter %}
  {{ cancer_filters(form, institute, case) }}
{% endblock %}

{% block variants_table_header %}
  <thead class="thead table-light">
    <tr>
      <th style="width:2%"></th>
      <th title="Gene">Gene</th>
      <th title="Variant" style="width:12%">HGVS[c/p]</th>
      <th title="Assessments including variant tier" style="width:8%">Assessment</th>
      <th data-bs-toggle="tooltip" title="Rank score (normalized rank score in the range 0-1)" style="width:5%">Rank</th>
      <th title="CADD scores" style="width:4%">CADD</th>
      <th title="Genomic coordinate" style="width:8%">Chr pos</th>
      <th title="Population frequency">Pop Freq</th>
      <th title="Observed" style="width:7%">Observed</th>
      <th title="Variant type">Type</th>
      <th title="Callers" style="width:12%">Callers</th>
      <th title="Functional consequence annotation" style="width:10%">Consequence</th>
      <th data-bs-toggle="tooltip" data-bs-placement="top" title="Tumor alt. AF. &#013; Alt. allele count | Ref. allele count">Tumor</th>
      <th data-bs-toggle="tooltip" data-bs-placement="top" title="Normal alt. AF. &#013; Alt. allele count | Ref. allele count">Normal</th>
    </tr>
  </thead>
{% endblock %}

{% block variants_table_rows %}
  {% for variant in variants %}
    {{ cancer_variant_row(variant, institute, case) }}
  {% else %}
    <tr>
      <td colspan="14">No matching variants</td>
    </tr>
  {% endfor %}
{% endblock %}

{% macro cancer_variant_row(variant, institute, case, ) %}
  <tr data-target="_blank" data-href="{{ variant_link_href(variant, institute, case) }}"
  {% if variant.dismiss_variant %}
    class="dismiss">
  {% elif 'causatives' in case and variant._id in case.causatives %}
    class="causative">
  {% else %}
    >
  {% endif %}
    <td class="no-row-click">
      <input type="checkbox" value="{{variant._id}}" name="dismiss" onclick="enableDismiss()">
      {{ pin_indicator(variant, case) }}
    </td>
    <td>{{ gene_cell(variant) }}</td>
    <td>
      <a target="_blank" href="{{ variant_link_href(variant, institute, case) }}">
        {% if variant.first_rep_gene.hgvs_identifier %}
          <div>{{ variant.first_rep_gene.hgvs_identifier|truncate(30, True) }}</div>
          <div>{{ (variant.first_rep_gene.hgvsp_identifier or '') |url_decode|truncate(30, True) }}</div>
        {% else %}
          <div>{{ variant.reference|truncate(30, True) }}â†’
            {% if variant.alternative | length > 5 %}
              {{ variant.alternative[0] }}...{{ variant.alternative[-1] }}
            {% else %}
              {{ variant.alternative|truncate(30, True) }}
            {% endif %}
          </div>
        {% endif %}
      </a>
    </td>
    <td>
      {{ evaluations_badge(variant.evaluations) }}
      {{ dismissals_badge(variant) }}
      {{ matching_manual_rank(variant) }}
      {{ research_assessments_badge(variant) }}
      {{ clinical_assessments_badge(variant) }}
      {{ group_assessments_badge(variant) }}
      {{ comments_badge(case, institute, variant) }}
      {{ causative_badge(variant, case) }}
      {{ other_tiered_variants(variant.matching_tiered) }}
      {{ other_tiered_variants(variant.matching_escat_tiered) }}
      {{ evaluations_badge(variant.ccv_evaluations) }}
    </td>
    <td>{{ rank_cell(variant) }}</td>
    <td>{{ cadd_cell(variant) }}</td>
    <td>{{ position_cell(variant) }}</td>
    <td class="text-end">{{ frequency_cell_general(variant) }}</td>
    <td>{{ observed_cell_general(variant) }}</td>
    <td>{{ variant.sub_category|upper }}</td>
    <td>{{ callers_cell(variant) }}</td>
    <td>{{ variant_funct_anno_cell(variant) }}</td>
    <td>{{ allele_cell(variant.tumor or {}) }}</td>
    <td>{{ allele_cell(variant.normal or {}) }}</td>
  </tr>
{% endmacro %}

{% macro actions_cell(variant) %}
  <a href="{{ url_for('variant.variant', institute_id=institute._id, case_name=case.display_name,
                      variant_id=variant._id, cancer='yes') }}">View</a>
  {% if variant.comments %}
    <span class="glyphicon glyphicon-comment"></span>
  {% endif %}
{% endmacro %}

{% macro rank_cell(variant) %}
  {% if variant.rank_score is defined %}
    {% if variant.rank_score <= 4 %}
      {% set label_class = 'secondary' %}
    {% elif variant.rank_score == 5 %}
      {% set label_class = 'info' %}
    {% elif variant.rank_score == 6 %}
      {% set label_class = 'primary' %}
    {% elif variant.rank_score == 7 %}
      {% set label_class = 'warning' %}
    {% elif variant.rank_score > 8 %}
      {% set label_class = 'danger' %}
    {% endif %}
    <div class="badge bg-{{ label_class }}" data-bs-toggle="tooltip" data-bs-placement="top" title="Rank score">
      {{ variant_rank_score(variant) }}
    </div>
  {% endif %}
{% endmacro %}

{% macro cadd_cell(variant) %}
  {% if variant.cadd_score %}
    {% if variant.cadd_score <= 10 %}
      {% set label_class = 'secondary' %}
    {% elif variant.cadd_score <= 20 %}
      {% set label_class = 'primary' %}
    {% elif variant.cadd_score <= 25 %}
      {% set label_class = 'warning' %}
    {% elif variant.cadd_score > 29 %}
      {% set label_class = 'danger' %}
    {% endif %}
    <div class="badge bg-{{ label_class }}" data-bs-toggle="tooltip" data-bs-placement="top" title="CADD score">{{ variant.cadd_score|round }}</div>
  {% endif %}
{% endmacro %}

{% macro position_cell(variant) %}
  <span class="text-body"><b>{{ variant.chromosome }}</b>:{{ variant.position }}</span>
{% endmacro %}

{% block scripts %}
  {{ super() }}
  {{ external_scripts() }}
  <script src="{{ url_for('variants.static', filename='form_scripts.js') }}"></script>
  {{ filter_script_main(cytobands) }}
  <script type="text/javascript">

    $('select[multiple]').selectpicker({
      width: '100%'
    });

    window.onload=function() {
        populateCytobands({{cytobands|safe}});
        {{ update_stash_filter_button_status(current_user, filters) }}
    }

    $("#filters").change(function () {
      {{ update_stash_filter_button_status(current_user, filters) }}
    });

    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
    return new bootstrap.Popover(popoverTriggerEl, {
        sanitizeFn: function (content) {
          return DOMPurify.sanitize(content)
        },
        container: 'body',
      })
    })

    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    {{ clickable_table_row_script() }}

  </script>
  {{ enable_variants_hotkeys() }}
{% endblock %}
