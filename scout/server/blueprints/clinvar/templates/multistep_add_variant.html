{% extends "bootstrap_global.html" %}

{% block css %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('clinvar.static', filename='form_style.css') }}"></link>
{% endblock %}

{% block head %}
  {{ super() }}
{% endblock head %}

{% block content %}
{% if variant_data.var_obj.category in ["snv", "cancer"]%}
  {% set var_category = 'snv' %}
{% else %}
  {% set var_category = 'sv' %}
{% endif %}
<div class="container-fluid">
  <!-- MultiStep Form -->
  <div class="row d-flex justify-content-center">
      <div class="col-md-10">
          <form id="clinVarAdd" method="POST" action="{{ url_for('clinvar.clinvar_save', institute_id=institute._id, case_name=case.display_name) }}" id="{{variant_data.var_id}}_form">
              <!-- progressbar -->
              <ul id="progressbar">
                  <li class="active">Help</li>
                  <li>Assertion Criteria</li>
                  <li>Variant Details</li>
                  <li>Inheritance Model</li>
                  <li>Clinical Significance</li>
                  <li>Associated conditions</li>
                  <li>Observation Data</li>
              </ul>
              <!-- fieldsets -->
              <fieldset>
                The form present on this page mirrors the fields on the Clinvar submission spreadsheets. After collecting the required fields for submitting the to Clinvar, this variant gets saved in a ClinVar submission object.<br>
                <input type="button" name="next" class="next action-button" value="Next"/>
              </fieldset>

              <fieldset>
                <!-- hidden fields -->
                {{ variant_data.var_form.csrf_token }}
                <!-- Variant data form -->
                {{ variant_data.var_form.case_id() }}
                {{ variant_data.var_form.category() }}
                {{ variant_data.var_form.local_id() }}
                {{ variant_data.var_form.linking_id() }}
                {{ variant_data.var_form.ref() }}
                {{ variant_data.var_form.alt() }}

                <!-- SNVs only -->
                {% if var_category == 'snv' %}
                  {{ variant_data.var_form.chromosome() }}
                  {{ variant_data.var_form.start() }}
                  {{ variant_data.var_form.stop() }}
                {% endif %}
                <!-- end hidden fields -->
                <h2 class="fs-title">Assertion Criteria</h2>
                <h3 class="fs-subtitle"></h3>

                  {{variant_data.var_form.last_evaluated.label}}
                  {{variant_data.var_form.last_evaluated}}

                  {{variant_data.var_form.assertion_method.label}}
                  {{variant_data.var_form.assertion_method()}}

                  {{variant_data.var_form.assertion_method_cit.label}}
                  {{variant_data.var_form.assertion_method_cit}}

                <input type="button" name="next" class="next action-button" value="Next"/>
              </fieldset>
              <fieldset>
                  <h2 class="fs-title">Variant Details</h2>

                  {{variant_data.var_form.gene_symbol.label}}
                  {{variant_data.var_form.gene_symbol()}}
                  <h3 class="fs-subtitle">Gene symbol should be provided only to indicate the gene-disease relationship supporting the variant interpretation. **Gene symbol is not expected for CNVs**, except to make a statement that a specific gene within the variant has a relationship to the interpreted condition.</h3>

                  {% if var_category == 'snv' %}
                    <!-- Transcripts & HGVS:(optional) -->
                    {{variant_data.var_form.tx_hgvs.label}}
                    {% for item_row in variant_data.var_form.tx_hgvs | batch(3) %}
                      <div class="row">
                      {% for item in item_row %}
                        <div class="col-4">{{ item() }} {{item.label }}</label></div>
                      {% endfor %}
                      </div>
                    {% endfor %}
                    <br>
                    <!-- dbSNP identifier -->
                    {{variant_data.var_form.variations_ids.label}}
                    {{variant_data.var_form.variations_ids()}}

                  {% else %} <!--SV variant-->
                    <div class="row">
                      <div class="col-6">
                      <!-- Variant type -->
                        {{variant_data.var_form.sv_type.label}}
                        {{variant_data.var_form.sv_type(class="form-control")}}
                      <!-- Reference copy number -->
                        {{variant_data.var_form.ref_copy_number.label}}
                        {{variant_data.var_form.ref_copy_number(size=5)}}
                        <!-- Copy number -->
                        {{variant_data.var_form.copy_number.label}}
                        {{variant_data.var_form.copy_number(size=5)}}
                      <!--start and end chroms-->
                        {{variant_data.var_form.chromosome.label()}}
                        {{variant_data.var_form.chromosome(size=5)}}
                        {{variant_data.var_form.end_chromosome.label()}}
                        {{variant_data.var_form.end_chromosome(size=5)}}
                      </div>
                      <div class=col-6>
                        <!-- BP1 -->
                        {{variant_data.var_form.breakpoint1.label()}}
                        {{variant_data.var_form.breakpoint1()}}
                        <!-- BP2 -->
                        {{variant_data.var_form.breakpoint2.label()}}
                        {{variant_data.var_form.breakpoint2()}}
                        <!-- Outer start -->
                        {{variant_data.var_form.outer_start.label}}
                        {{variant_data.var_form.outer_start(size=20)}}
                        <!-- Inner start -->
                        {{variant_data.var_form.inner_start.label}}
                        {{variant_data.var_form.inner_start(size=20)}}
                        <!-- Inner stop -->
                        {{variant_data.var_form.inner_stop.label}}
                        {{variant_data.var_form.inner_stop(size=20)}}
                        <!-- Outer stop -->
                        {{variant_data.var_form.outer_stop.label}}
                        {{variant_data.var_form.outer_stop(size=20)}}
                      </div>
                    </div>
                  {% endif %}
                  <input type="button" name="previous" class="previous action-button-previous" value="Previous"/>
                  <input type="button" name="next" class="next action-button" value="Next"/>
              </fieldset>

              <fieldset>
                <h2 class="fs-title">Inheritance model</h2>
                <h3 class="fs-subtitle">The mode of inheritance specific to the variant-disease pair, not generally for the disease</h3>
                {{variant_data.var_form.inheritance_mode.label}}
                {{variant_data.var_form.inheritance_mode(class="form-control")}}
                <input type="button" name="previous" class="previous action-button-previous" value="Previous"/>
                <input type="button" name="next" class="next action-button" value="Next"/>
              </fieldset>

              <fieldset>
                <h2 class="fs-title">Clinical Significance</h2>
                <h3 class="fs-subtitle">The interpretation, or clinical significance, of the variant for the submitted condition</h3>

                {{variant_data.var_form.clinsig.label}} <span class="text-danger" data-bs-toggle='tooltip' title="Required field"><strong>*</strong></span>
                {{variant_data.var_form.clinsig(class="form-control")}}

                {{variant_data.var_form.clinsig_cit.label}}
                {{variant_data.var_form.clinsig_cit(class="form-control", placeholder="(optional) e.g. PMID:123456,  PMCID:PMC3385229, NBK:56955")}}

                {{variant_data.var_form.clinsig_comment.label}}
                {{variant_data.var_form.clinsig_comment(class="form-control", placeholder="(optional)")}}

                <input type="button" name="previous" class="previous action-button-previous" value="Previous"/>
                <input type="button" name="next" class="next action-button" value="Next"/>
              </fieldset>

              <fieldset>
                <h2 class="fs-title">Associated Conditions</h2>
                <h3 class="fs-subtitle">The condition for which the variant is interpreted. Detailed information about reporting condition is available at <a href="https://www.ncbi.nlm.nih.gov/clinvar/docs/faq_submitters/#pheno" target="_blank" rel="noopener">https://www.ncbi.nlm.nih.gov/clinvar/docs/faq_submitters/#pheno</a>. If multiple conditions are submitted for a variant, this indicates that the variant was interpreted for the combination of conditions in the same individual(s).  i.e. this variant causes both condition A and condition B in the same individual. This scenario is most common for a new disease or syndrome that does not yet have a name and is described by several clinical features.  If you want to indicate that the variant has been interpreted for more than one condition, please submit these as separate records. i.e. this variant causes condition A in some individuals and causes disease B in other individuals. Provide only one name or identifier for a condition; do not provide multiple names or identifiers for the same condition."</h3>

                {% if variant_data.var_form.omim_terms.choices %}
                  {{variant_data.var_form.omim_terms.label}}
                  {% for item_row in variant_data.var_form.omim_terms | batch(4) %}
                    <div class="row">
                    {% for item in item_row %}
                      <div class="col-4">{{ item() }} {{item.label }}</label></div>
                    {% endfor %}
                    </div>
                  {% endfor %}
                {% endif %}
                <br>

                {% if variant_data.var_form.hpo_terms.choices %}
                  {{variant_data.var_form.hpo_terms.label}}
                  {% for item_row in variant_data.var_form.hpo_terms| batch(4) %}
                    <div class="row">
                    {% for item in item_row %}
                      <div class="col-4">{{ item() }} {{item.label}}</label></div>
                    {% endfor %}
                    </div>
                  {% endfor %}
                {% endif %}
                <br>

                {{variant_data.var_form.condition_comment.label}}
                {{variant_data.var_form.condition_comment(class="form-control")}}

                <input type="button" name="previous" class="previous action-button-previous" value="Previous"/>
                <input type="button" name="next" class="next action-button" value="Next"/>
              </fieldset>

              <fieldset>
                <h2 class="fs-title">Observation Data</h2>
                <h3 class="fs-subtitle">Information provided by filling in these fields will be used to create the CaseData.csv file. Observations from at least one individuals are required.</h3>

                <ul class="list-group">
                {% for cdata in variant_data.cdata_forms %}
                  {{cdata.linking_id}} <!-- hidden field -->
                  <li class="list-group-item">
                    <div class="row">
                      <div class="col-2">
                        {{ cdata.include_ind.label }}
                        {{ cdata.include_ind() }}
                      </div>
                      <div class="col-2">
                        {{ cdata.individual_id.label }}
                        {{ cdata.individual_id(class="form-control", readonly=true) }}
                      </div>
                      <div class="col-2">
                        {{ cdata.affected_status.label }}
                        {{ cdata.affected_status(class="form-control") }}
                      </div>
                      <div class="col-2">
                        {{ cdata.allele_of_origin.label }}
                        {{ cdata.allele_of_origin(class="form-control") }}
                      </div>
                      <div class="col-2">
                        {{ cdata.collection_method.label }}
                        {{ cdata.collection_method(class="form-control") }}
                      </div>
                    </div>
                  </li>
                {% endfor %}
                </ul>


                <input type="button" name="previous" class="previous action-button-previous" value="Previous"/>
                <input type="submit" name="submit" class="submit action-button" value="Submit"/>
              </fieldset>



          </form>
      </div>
  </div>
  <!-- /.MultiStep Form -->
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>
<script>
var current_fs, next_fs, previous_fs; //fieldsets
var left, opacity, scale; //fieldset properties which we will animate
var animating; //flag to prevent quick multi-click glitches

$(".next").click(function(){
	if(animating) return false;
	animating = true;

	current_fs = $(this).parent();
	next_fs = $(this).parent().next();

	//activate next step on progressbar using the index of next_fs
	$("#progressbar li").eq($("fieldset").index(next_fs)).addClass("active");

	//show the next fieldset
	next_fs.show();
	//hide the current fieldset with style
	current_fs.animate({opacity: 0}, {
		step: function(now, mx) {
			//as the opacity of current_fs reduces to 0 - stored in "now"
			//1. scale current_fs down to 80%
			scale = 1 - (1 - now) * 0.2;
			//2. bring next_fs from the right(50%)
			left = (now * 50)+"%";
			//3. increase opacity of next_fs to 1 as it moves in
			opacity = 1 - now;
			current_fs.css({
        'transform': 'scale('+scale+')',
        'position': 'absolute'
      });
			next_fs.css({'left': left, 'opacity': opacity});
		},
		duration: 800,
		complete: function(){
			current_fs.hide();
			animating = false;
		},
		//this comes from the custom easing plugin
		easing: 'easeInOutBack'
	});
});

$(".previous").click(function(){
	if(animating) return false;
	animating = true;

	current_fs = $(this).parent();
	previous_fs = $(this).parent().prev();

	//de-activate current step on progressbar
	$("#progressbar li").eq($("fieldset").index(current_fs)).removeClass("active");

	//show the previous fieldset
	previous_fs.show();
	//hide the current fieldset with style
	current_fs.animate({opacity: 0}, {
		step: function(now, mx) {
			//as the opacity of current_fs reduces to 0 - stored in "now"
			//1. scale previous_fs from 80% to 100%
			scale = 0.8 + (1 - now) * 0.2;
			//2. take current_fs to the right(50%) - from 0%
			left = ((1-now) * 50)+"%";
			//3. increase opacity of previous_fs to 1 as it moves in
			opacity = 1 - now;
			current_fs.css({'left': left});
			previous_fs.css({'transform': 'scale('+scale+')', 'opacity': opacity});
		},
		duration: 800,
		complete: function(){
			current_fs.hide();
			animating = false;
		},
		//this comes from the custom easing plugin
		easing: 'easeInOutBack'
	});
});
</script>
{% endblock %}
