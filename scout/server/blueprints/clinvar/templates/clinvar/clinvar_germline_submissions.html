{% extends "layout.html" %}
{% from "overview/institute_sidebar.html" import institute_actionbar %}
{% from "clinvar/clinvar_howto.html" import clinvar_howto_modal %}
{% from "clinvar/components.html" import deprecated_submission_table, render_dict_array, variant_submission_table, update_submission_status_form %}

{% block title %}
  {{ super() }} - {{ institute.display_name }}
{% endblock %}

{% block top_nav %}
  {{ super() }}
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('cases.index') }}">Institutes</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('overview.cases', institute_id=institute._id) }}">{{ institute.display_name }}</a>
  </li>
  <li class="nav-item active d-flex align-items-center">
    <span class="navbar-text">Clinvar germline submissions</span>
  </li>
{% endblock %}


{% macro submissions_macro(submissions) %}
<div class="container-float">
  <h3 class="mt-3">ClinVar germline submissions</h3><a data-bs-target="#howto" href="#" data-bs-toggle="modal">howto</a><br>
  <!-- Modal -->
  {{ clinvar_howto_modal() }}
  <!-- Modal end -->
  <br>

  <div class="mb-2">
      <form id="search-form" class="d-flex gap-2 align-items-start" action="{{ url_for('clinvar.clinvar_germline_submissions', institute_id=institute._id) }}">
        <input type="text" class="form-control" name="clinvar_id_filter"
               placeholder="Enter ClinVar submission IDâ€¦"
               value="{{clinvar_id_filter if clinvar_id_filter}}"
               style="max-width: 250px;">
        <button class="btn btn-primary" type="submit">Search</button>
        <a href="{{ url_for('clinvar.clinvar_germline_submissions', institute_id=institute._id) }}" class="btn btn-secondary text-white">Show All</a>
      </form>
    </div>

  {% if submissions %}

    <div style="overflow-y: auto; height: 1000px;">
    {% for status in ['open', 'closed', 'submitted', 'deprecated'] %}
      {% for submission in submissions|sort(attribute='status') %}
        {% if submission.status==status %}
          {{ submission_panel(submission) }}
        {% endif %}
      {% endfor %}
    {% endfor %}
    </div>
  {% else %}
  <p>No ClinVar submissions found. You can create one by choosing one or more pinned variants on a case page and clicking the button "Submit to ClinVar".</p>
  {% endif %}
</div>
{% endmacro %}

{% macro submission_panel(subm_obj) %}
<div class="accordion accordion-flush" id="accordionFlushSubmissions">
  <div class="accordion-item">
    <h2 class="accordion-header" id="header-{{subm_obj._id}}">
      <a class="accordion-button collapsed {% if subm_obj.status=='open' %} link-primary {% elif subm_obj.status=='submitted' %} link-success {% else %} link-secondary {% endif%}" type="button" data-bs-toggle="collapse" data-bs-target="#flush-{{subm_obj._id}}" aria-expanded="false" aria-controls="flush-{{subm_obj._id}}" style="text-decoration: none;">
        Submission&nbsp;<strong>{{subm_obj._id}} - ({{subm_obj.status|upper}})</strong>&nbsp;/&nbsp;Created {% if subm_obj.created_by %}&nbsp;by&nbsp;<strong>{{subm_obj.created_by}}</strong>{% endif %}&nbsp;on&nbsp;<strong>{{subm_obj.created_at.strftime('%Y-%m-%d')}}</strong>&nbsp;/&nbsp;Last updated:&nbsp;<strong>{{subm_obj.updated_at.strftime('%d-%m-%Y, %T')}}</strong>
      </a>
    </h2>
    <div id="flush-{{subm_obj._id}}" class="accordion-collapse collapse" aria-labelledby="header-{{subm_obj._id}}" data-bs-parent="#accordionFlushSubmissions">
      <div class="accordion-body">
        <div class="row">
          {{ update_submission_status_form(institute, subm_obj) }}
        </div>
        <div class="row">
          <table>
            <caption></caption>
            <tr><th></th></tr>
            <tr>
              <form id="updateName_{{subm_obj._id}}" action="{{ url_for('clinvar.clinvar_update_submission', institute_id=institute._id, submission=subm_obj._id) }}" method="POST">
              <td style="width: 10%"><label for="clinvar_id">Submission ID</label></td>
              <td style="width: 25%"> <input type="text" class="form-control" name="clinvar_id" pattern="SUB[0-9]+" placeholder="ex: SUB1234567" value="{{ subm_obj.clinvar_subm_id or ""}}"></td>
              <td style="width: 20%"><button type="submit" class="btn btn-sm btn-primary form-control" name="update_submission" value="register_id">Update ID manually</button></td>
              </form>
              {% if subm_obj.status == 'open' and show_submit  %}
                <form id="useApi_{{subm_obj._id}}" action="{{ url_for('clinvar.send_api_submission', institute_id=institute._id, submission=subm_obj._id, subm_type='germline') }}" method="POST">
                {{ submit_modal() }}
                  <td style="width: 20%"><button type="button" class="btn btn-sm btn-success form-control" name="update_submission" value="api_submit" data-bs-toggle="modal" data-bs-target="#submitModal">Submit to ClinVar</button></td>
                </form>
              {% endif %}
              {% if subm_obj.status == 'submitted' %} <!--Submission status query -->
                 <form id="statusApi_{{subm_obj._id}}" action="{{ url_for('clinvar.clinvar_submission_status', submission_id=subm_obj.clinvar_subm_id) }}" method="POST">
                   {{ action_modal("status", subm_obj._id) }}
                   <td style="width: 20%"><button type="button" class="btn btn-sm btn-secondary form-control" name="status_enquiry" value="api_status" data-bs-toggle="modal" data-bs-target="#statusModal_{{subm_obj._id}}">Submission status enquiry</button></td>
                 </form>
              {% endif %}
            </tr>
          </table>
        </div>
        <div>
          {% if subm_obj.germlineSubmission and subm_obj.germlineSubmission | length > 0 %}
            {{ variant_submission_table(subm_obj, "germline") }}
          {% elif not subm_obj.type and subm_obj.variant_data %} <!-- Deprecated submission type -->
            {{ deprecated_submission_table(subm_obj) }}
          {% else %}
            <p>This submission has no variants yet.</p>
          {% endif %}
        </div> <!--variant data div end -->
      </div>
    </div>
  </div>
</div>
{% endmacro %}

{% macro case_link(institute_id, case_name) %}
{% if "N/A" in case_name %}
  {{ case_name }}
{% else %}
  <a href="{{ url_for('cases.case', institute_id=institute_id, case_name=case_name) }}" target="_blank">{{case_name}}</a>
{% endif %}
{% endmacro %}

{% macro action_modal(action_type, subm_id) %}
<div class="modal fade" id="{{action_type}}Modal_{{subm_id}}" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Submission {{action_type}}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <label for="apiKey">Submitter's <a href="https://www.ncbi.nlm.nih.gov/clinvar/docs/api_http/" target="_blank" rel="noopener">API key</a></label>
        <input type="password" class="form-control" name="apiKey" id="apiKey" placeholder="64 alphanumeric characters" value="{{institute.clinvar_key or ''}}" required>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="submit" name="{{action_type}}" value="{{action_type}}" class="btn btn-primary">Submission {{action_type}} enquiry</button>
      </div>
    </div>
  </div>
</div>
{% endmacro %}

{% macro submit_modal() %}
<div class="modal fade" id="submitModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ClinVar API submission</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <label for="apiKey">Submitter's <a href="https://www.ncbi.nlm.nih.gov/clinvar/docs/api_http/" target="_blank" rel="noopener">API key</a></label>
        <input type="password" class="form-control" name="apiKey" id="apiKey" placeholder="64 alphanumeric characters" value="{{institute.clinvar_key or ''}}" required>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="submit" name="update_submission" value="submit" class="btn btn-primary">Submit variants</button>
      </div>
    </div>
  </div>
</div>
{% endmacro %}

{% block content_main %}
<div class="container-float">
  <div class="row" id="body-row"> <!--sidebar and main container are on the same row-->
    {{ institute_actionbar(institute, "shared") }} <!-- This is the sidebar -->
  <div class="col">
    {{ submissions_macro(submissions) }}
  </div>
  </div> <!-- end of div id body-row -->
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script type="text/javascript">

  // Enable tooltips
  var tooltipTriggerList = Array.prototype.slice.call(
    document.querySelectorAll('[data-bs-toggle="tooltip"]')
  )
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl)
  })

  $(function () {
      $('.casedata  div').hide();
      $('.vardata  div').hide();
      $('.cd_btn').on('click', function(){
          var bid = $(this)[0].id;
          var sel = '#cddiv' + bid;
          if($(sel).is(':visible')){
            $(sel).hide();
          }
          else{
            $('.casedata  div').hide();
            $(sel).fadeToggle();
          }
      });
      $('.var_btn').on('click', function(){
          var bid = $(this)[0].id;
          var sel = '#vardiv' + bid;
          if($(sel).is(':visible')){
            $(sel).hide();
          }
          else{
            $('.vardata div').hide();
            $(sel).fadeToggle();
          }
      });
  });

</script>
{% endblock %}
