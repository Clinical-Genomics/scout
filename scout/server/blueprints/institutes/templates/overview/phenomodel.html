{% extends "layout_bs4.html" %}
{% from "overview/institute_sidebar.html" import institute_actionbar %}

{% block title %}
  {{ super() }} - {{ institute.display_name }} - Advanced phenotype models
{% endblock %}

{% block css %}
{{ super() }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.9/dist/css/bootstrap-select.min.css">
<link href="https://cdn.jsdelivr.net/npm/select2@4.0.12/dist/css/select2.min.css" rel="stylesheet" />
<style>
.tree {
  list-style-type: none;
}
</style>
{% endblock %}

{% block top_nav %}
  {{ super() }}
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('cases.index') }}">Institutes</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('overview.cases', institute_id=institute._id) }}">{{ institute.display_name }} cases </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('overview.advanced_phenotypes', institute_id=institute._id) }}">Advanced phenotype models </a>
  </li>
  <li class="nav-item active">
    <a class="nav-link" href="#">{{phenomodel.name}}</a>
  </li>
{% endblock %}

{% macro hpo_search() %}
  <div class="row">
    <div class="form-group col-8">
      <input type="text" class="typeahead_hpo form-control" name="hpo_term" id="hpo_term" data-provide="typeahead" autocomplete="off" placeholder="Search HPO phenotype..">
    </div>
    <div class="form-group col-2">
      <button type="submit" name="add_hpo" class="btn btn-outline-secondary btn">Add</button>
    </div>
  </div>
{% endmacro %}

{% macro phenomodel_macro() %}
<div class="card mt-3">
  <div style="padding: 0;" class="card-body mt-3 ml-3 mr-3">
    <form action="#" method="POST">
        <input type="hidden" name="model_id" value="{{phenomodel._id}}">
      <div class="form-row">
        <div class="col-4">
          {{ pheno_form.model_name(class="form-control", placeholder="Name") }}
        </div>
        <div class="col-7">
          {{ pheno_form.model_desc(class="form-control", placeholder="Description (optional)") }}
        </div>
        <div class="col-1">
          <button type="submit" value="update" name="update_model" class="btn btn-primary">update</button
        </div>
      </div>
      <h6 class="text-muted ml-3 mt-3">created: {{phenomodel.created.strftime('%Y-%m-%d')}} - updated: {{phenomodel.updated.strftime('%Y-%m-%d')}}</h6>
    </form>
  </div>
</div>
</div>

<div id="accordion" class="mt-3">
  <a class="btn btn-primary btn-sm" data-toggle="collapse" data-parent="#accordion" href="#new_subpanel">Create a new HPO subpanel</a>
  <div class="panel-collapse collapse {{'show' if show_subpanel == True}} mt-3 mb-3" id="new_subpanel">
    <div class="card mt-3">
      <form action="#" id="new_subpanel_form" method="POST">
        {{ subpanel_form.csrf_token }}
        <div class="form-row ml-3 mr-3 mt-3 mb-3">
          <div class="col-5">
            {{ subpanel_form.title.label }}:
            {{ subpanel_form.title(class="form-control") }}
          </div>
          <div class="col-5">
            {{ subpanel_form.subtitle.label }}:
            {{ subpanel_form.subtitle(class="form-control") }}
          </div>
          <div class="col-md-2 mt-3">
            {{ subpanel_form.add_subpanel( class="control-label btn btn-primary mt-3") }}
          </div>
        </div><!-- end of form-row -->
      </form>
    </div>
  </div>
</div>
{{ subpanels_macro() }}
{% endmacro %}

{% macro subpanels_macro()%}
  {%if phenomodel.submodels %}
    {% for submodel_id, submodel in phenomodel.submodels.items()%}
      <form action="#" method="POST">
        <div class="card mt-3">
          <div class="card-body">
            <div class="row">
              <div class="col-3">
                <h5 class="card-title">{{submodel.title}}</h5>
                <h6 class="card-subtitle mb-2 text-muted">{{submodel.subtitle}}</h6>
                <br>
              </div>
              <!-- Display HPO models tree -->
              <div class="col-9">
                <!-- HPO term search -->
                {{ hpo_search() }}
                <!-- end of HPO term search -->
                <table class="table table-striped">
                {% if "hpo_groups" in submodel %}
                  {% for term_id, term_obj in submodel.hpo_groups.items() %}
                    <tr>
                      <td>
                        <input type="checkbox" id="{{term_id}}" name="{{term_id}}">
                        <label for="{{term_tree}}">{{ term_id }}<strong>({{term_obj.description}})</strong></label>
                        <div style="margin-left: 35px">
                          {% for item in term_obj.children recursive %}
                            <li class="tree">
                              <label for="{{item.name}}">{{ item.name }}<strong>({{item.description}})</strong></label>
                              {%- if item.children -%}
                                <ul class="tree">{{ loop(item.children) }}</ul>
                              {%- endif %}
                            </li>
                          {%- endfor %}
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                {% endif %}
                </table>
              </div> <!--end of phenotype tree column div-->
            </div> <!--end of div row-->
            <div class="d-flex flex-row-reverse">
              <button class="btn btn-danger btn-sm" type="submit" name="remove_submodel" aria-hidden="true">Remove submodel <i class="fa fa-times"></i></button>
            </div>
          </div>
        </div>
      </form>
    {% endfor %}
  {% endif %}
{% endmacro %}


{% block content_main %}
<div class="container-float">
  <div class="row" id="body-row"> <!--sidebar and main container are on the same row-->
    {{ institute_actionbar(institute) }} <!-- This is the sidebar -->
  <div class="col">
    {{ phenomodel_macro() }}
  </div>
</div><!-- end of body row div -->
</div><!-- end of container-float-->
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-3-typeahead/4.0.2/bootstrap3-typeahead.min.js"></script>
<script>
  function getHpoTerms(query, process) {
    $.get("{{ url_for('cases.hpoterms') }}", {query: query}, function(data) {
      process(data)
    });
  };

  $(".typeahead_hpo").typeahead({
    name: 'hpo_term',
    source: getHpoTerms,
    minLength: 3,
  });
</script>
{% endblock %}
