{% import "bootstrap/wtf.html" as wtf %}
{% extends "layout.html" %}
{% from "overview/institute_sidebar.html" import institute_actionbar %}
{% from "overview/utils.html" import analysis_type, cases_search_form %}

{% block title %}
  {{ super() }} - {{ institute.display_name }} - Cases
{% endblock %}

{% block top_nav %}
  {{ super() }}
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('cases.index') }}">Institutes</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('overview.cases', institute_id=institute._id) }}">{{ institute.display_name }}</a>
  </li>
  <li class="nav-item active d-flex align-items-center">
    <span class="navbar-text">Cases</span>
  </li>
{% endblock %}

{% macro case_row(case) %}
  <tr>
    <td>{{ case.name }}</td>  <!-- Adjust fields to match the 'case' object structure -->
    <td>{{ case.status }}</td>
    <td>{{ case.analysis_date }}</td>
    <td><a href="{{ case.link }}">Link</a></td>
    <td>{{ case.default_panel }}</td>
    <td>{{ case.seq }}</td>
    <td>{{ case.track }}</td>
    <td><button>Share</button></td>
  </tr>
{% endmacro %}

{% macro cases_table(group_name, cases) %}
<div class="card mt-3">
  <div class="card-body p-0">
    <div class="table-responsive"> <!-- Makes table scrollable on smaller screens -->
      <table class="table table-hover table-bordered">
        <thead>
          <tr>
            <th class="text-truncate" style="width: 21%">{{ group_name|capitalize }} cases ({{cases|length}}/{{status_ncases[group_name] or 0}})</th>
            <th style="width: 7%;">Status</th>
            <th style="width: 11%;">Analysis date</th>
            <th style="width: 22%;">Link</th>
            <th style="width: 21%;">Default panel</th>
            <th style="width: 3%;">Seq</th>
            <th style="width: 11%;">Track</th>
            <th style="width: 4%;">Share</th>
          </tr>
        </thead>
        <tbody>
        {% for case in cases %}
          {{ case_row(case) }}
        {% else %}
          <tr>
            <td colspan=8>No cases found with this query.</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endmacro %}

{% block content_main %}
<div class="container-fluid"> <!-- Full width for better responsiveness -->
  <div class="row">
    <div class="col-md-3 mb-3 col-sm-12"> <!-- Sidebar stacks on smaller screens -->
      {{ institute_actionbar(institute) }}
    </div>
    <div class="col-md-9 col-sm-12">
      <div class="card panel-default">
        <div class="card-body">
          {{ cases_search_form(form, url_for('overview.cases', institute_id=institute._id), url_for('overview.cases', institute_id=institute._id), institute) }}
        </div>
        <div class="card-footer text-center">
          Showing {{ found_cases }} / {{ nr_cases }} cases
        </div>
      </div>

      <div>
        {% set ordered_statuses = ['prioritized', 'inactive', 'active', 'archived', 'solved', 'ignored'] -%}
        {% for status in ordered_statuses %}
          {% for group_name, case_group in cases %}
            {% if status == group_name %}
              <div class="table-responsive">{{ cases_table(group_name, case_group) }}</div>
            {% endif %}
          {% endfor %}
        {% endfor %}
      </div>
    </div>
  </div>
</div>
{% endblock %}


