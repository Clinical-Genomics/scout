{% extends "variant/empty_acmg.html" %}
{% from "cases/utils.html" import pretty_link_variant %}

{% block title %}
  {{ super() }} - {{ institute.display_name }} - {{ case.display_name }} - {{ variant.display_name }} - Classify
{% endblock %}

{% block top_nav %}
  {{ super() }}
  <li class="nav-item">
    <a class="nav-link text-nowrap" href="{{ url_for('cases.index') }}">Institutes</a>
  </li>
  <li class="nav-item">
    <a class="nav-link text-nowrap" href="{{ url_for('overview.cases', institute_id=institute._id) }}">
      {{ institute.display_name }}
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link text-nowrap" href="{{ url_for('cases.case', institute_id=institute._id, case_name=case.display_name) }}">
      {{ case.display_name }}
    </a>
  </li>
  <li class="nav-item active d-flex align-items-center"
    {% if variant.category == "sv" %}
    data-bs-toggle="tooltip"
    data-bs-placement="bottom"
    title="âš  You are viewing a structural variant. This classification page is designed for SNVs. It may apply to small SVs. Otherwise follow ACMG SV guidelines (Riggs 2020), which are not yet in Scout. Use the manual Variant tag instead."
    {% endif %}>

    {% if variant.category == "sv" %}
        <i class="fa fa-exclamation-triangle text-warning me-1"></i>
    {% endif %}

    <span class="navbar-text">
        {{ variant.display_name|truncate(20, True) }}
    </span>
  </li>
{% endblock %}

{% block content_main %}
  {{ evaluation_tables() }}
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="https://cdn.jsdelivr.net/npm/html2canvas-pro@1.5.11/dist/html2canvas-pro.min.js" integrity="sha384-Wm+alMbg1fxSJBbLMXKBb1ZfoWBd0FwJml5aEbKolDB41cMjTfek0cLKgCku6MAF" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.3/jspdf.umd.min.js" integrity="sha384-GwHhSt8QjC7J+v0zZ0Flfho/T76YHEcCL9w4rvjTIUHauh6gWJeBSIi3vWXxNhtA" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    // Export to PDF
    document.getElementById('download-pdf').addEventListener('click', async function() {
    const container = document.querySelector('.container.mt-3.mb-5');
    const footer = document.querySelector('.mt-3.fixed-bottom.bg-light.border');

    if (!container) {
      alert('Container not found');
      return;
    }

    // Move footer into container temporarily
    let originalParent = null;
    let originalNextSibling = null;
    if (footer) {
      originalParent = footer.parentNode;
      originalNextSibling = footer.nextSibling;
      footer.style.position = 'relative';
      footer.style.bottom = '0';
      container.appendChild(footer);
    }

    // Force light mode on all child elements
    const allElements = container.querySelectorAll('*');
    allElements.forEach(el => {
      const computed = globalThis.getComputedStyle(el);
      if (computed.backgroundColor && computed.backgroundColor !== 'rgba(0, 0, 0, 0)' && computed.backgroundColor !== 'transparent') {
        el.dataset.originalBg = el.style.backgroundColor;
        el.style.backgroundColor = 'white';
      }
      if (computed.color) {
        el.dataset.originalColor = el.style.color;
        el.style.color = 'black';
      }
      if (computed.borderColor) {
        el.dataset.originalBorder = el.style.borderColor;
        el.style.borderColor = '#ccc';
      }
    });

    // Capture PDF
      const canvas = await html2canvas(container, { scale: 1, useCORS: true, backgroundColor: '#ffffff' });

      // Restore original styles
      allElements.forEach(el => {
        if (el.dataset.originalBg !== undefined) {
          el.style.backgroundColor = el.dataset.originalBg;
          delete el.dataset.originalBg;
        }
        if (el.dataset.originalColor !== undefined) {
          el.style.color = el.dataset.originalColor;
          delete el.dataset.originalColor;
        }
        if (el.dataset.originalBorder !== undefined) {
          el.style.borderColor = el.dataset.originalBorder;
          delete el.dataset.originalBorder;
        }
      });

      // Restore footer to original position
      if (footer) {
        if (originalNextSibling) {
          originalNextSibling.before(footer);
        } else {
          originalParent.appendChild(footer);
        }
        footer.style.position = 'fixed';
      }

      // Generate PDF
      const imgData = canvas.toDataURL('image/jpeg', 0.75);
      const { jsPDF } = globalThis.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
      pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
      pdf.save('{{case.display_name}}_{{variant.display_name}}_acmg.pdf');
    });
  </script>
{% endblock %}
