{% extends "layout_bs4.html" %}

{% block content_main %}
{% set panel = panel|int %}
  <div class="container-float">
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item"><a href="#" class="nav-link {% if panel == 1 %}active{% endif %}" data-toggle="tab" onclick="hide_div(1)"><h4>General statistics</h4></a></li>
        <li class="nav-item"><a href="#" class="nav-link {% if panel == 2 %}active{% endif %}" data-toggle="tab" onclick="hide_div(2)"><h4>Case statistics</h4></a></li>
        <li class="nav-item"><a href="#" class="nav-link {% if panel == 3 %}active{% endif %}" data-toggle="tab" onclick="hide_div(3)"><h4>Variant statistics</h4></a></li>
      </ul>
    <div class="tab-content" id="tabs">
      <div class="tab-pane" id="1">
        {{ basic_stats() }}
      </div>
      <div class="tab-pane" id="2">
        {{ cases_stats() }}
      </div>
      <div class="tab-pane" id="3">
        {{ variants_stats() }}
      </div>
    </div>
  </div>

{% endblock %}

{% macro basic_stats() %}
<div class="card">
  <div class="card-body">
    {{ dashboard_search_form(1) }}
    {{ general_stats_panels() }}
  </div>
</div>
{% endmacro %}

{% macro cases_stats() %}
<div class="card">
  <div class="card-body">
    {{ dashboard_search_form(2) }}
    {{ cases_stats_panels() }}
  </div>
</div>
{% endmacro %}

{% macro variants_stats() %}
<div class="card">
  <div class="card-body">
    {{ dashboard_search_form(3) }}<br><br>
    {{ variants_stats_panels() }}
  </div>
</div>
{% endmacro %}

{% macro dashboard_search_form(pane) %}
<br>
<form id='form' class="form-horizontal" method='POST' action="{{ url_for('dashboard.index') }}" accept-charset="utf-8">
    <input type="hidden" value={{pane}} name="pane_id" id="pane_id">
    <div class="row text-center">
      <div class="col-md-4 col-xs-4">
        {% if pane in (1,2) %}
          <div class="input-group">
            <span class="input-group-addon">
              <span class="glyphicon glyphicon-search"></span>
            </span>
            <input type="search" class="form-control" value="{{ query if query }}" name="query" id="query" placeholder="Enter query to filter cases summarized below" onchange="update_select({% if current_user.is_admin %}true{% else %}false{% endif %})"></input>
          </div>
        {% endif %}
      </div>
      <div class="col-md-2 col-xs-2">
      <select name="institute" id="institute" onchange="this.form.submit()">
        {% for inst in institutes %}
          {% if inst.display_name == 'All institutes' and query and not current_user.is_admin %}
            <option value="{{ inst._id }}" disabled>{{ inst.display_name }}</option>
          {% else %}
            <option value="{{ inst._id }}" {{ "selected" if inst._id == choice }} >{{ inst.display_name }}</option>
          {% endif %}
        {% endfor %}
      </select>
      </div>
      <div class="col-md-2 col-xs-2">
        <button type="submit" class="form-control">Search</input>
      </div>
    </div>
    {% if pane in (1,2) %}
    <div class="bottom-align-text">
      <br>Examples: case_id=<strong>18201</strong>, HPO-term=<strong>HP:0001166</strong>, synopsis=<strong>synopsis:epilepsy</strong>, panel=<strong>panel:NMD</strong>, phenotype group=<strong>PG:0100022</strong>, cohort=<strong>cohort:pedhep</strong>.
    </div>
    {% endif %}
  </form>
  <br>
{% endmacro %}

{% macro general_stats_panels() %}
<div class="mt-3 text-center">
  <div class="row">
    <div class="col-md-4">
      <h1>Samples</h1>
      <div>
        <canvas id="ngsType" height="150"></canvas>
        {% for group in analysis_types %}
          Total {{ group.name|upper }} samples (not cases): {{ group.count }}<br>
        {% endfor %}
      </div>
    </div> <!--  end of sample statistics div -->
    <div class="col-md-4">
      <h1>Cases</h1>
      <div>
          <canvas id="casesType" height="150"></canvas>
          {% for group in cases %}
            Cases {{ group.status|capitalize }}: {{ group.count }} <span class="text-muted">({{(group.percent * 100)|round(1)}}%)</span><br>
          {% endfor %}
      </div>
    </div> <!--  end of case statistics div -->
    <div class="col-md-4">
      <h1>Pedigree info</h1>
      <div>
        <canvas id="pedigreeTypes" height="150"></canvas>
        {% for topic in pedigree %}
          {{ topic.title }} Cases: {{ (topic.percent * 100)|round(1) }}%<br>
        {% endfor %}
      </div>
    </div> <!--  end of pedigree info div -->

  </div> <!-- end of class="row"-->
</div>
{% endmacro %}


{% macro cases_stats_panels() %}
<div class="container-float mt-3 text-center">
  <div class="row">
    <div class="col-md-12">
        <h1>Cases with...</h1>
        <canvas id="cases-bar-horiz" height="80"></canvas>
    </div>
  </div>
</div>
{% endmacro %}


{% macro variants_stats_panels() %}
<div class="container-float mt-3 text-center">
  <div class="row">
    <div class="col-md-12">
        <canvas id="var-validations" height="70"></canvas>
        {% for topic in variants %}
          {{ topic.title }} Cases: : {{ topic.count }} <span class="text-muted">({{ (topic.percent * 100)|round(1) }}%)</span><br>
        {% endfor %}
    </div>
  </div>
  <div id="card mt-3">
    <form id="dowload_var_stats" action="{{ url_for('variants.download_verified')}}" method="GET">
      <button type="submit" name="verified_vars" value="verified" class="btn btn-primary btn-md">Download all verified variants for your cases</button>
    </form>
  </div>
</div>
{% endmacro %}

{% block scripts %}
  {{ super() }}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.min.js"></script>

  <script type="text/javascript">

    var bkgColors = [ "#FDB45C", "#949FB1", "#00b0f0", "#F7464A", "#44449B", "#46BFBD"];
    var hoverColors = [ "#FFC870", "#A8B3C5", "#0287b8", "#FF5A5E", "#353578", "#5AD3D1"];

    //create analysis type chart
    createChart(document.getElementById("ngsType").getContext('2d'), analysisTypeData())
    //create cases types chart
    createChart(document.getElementById("casesType").getContext('2d'), casesType())
    //create pedigree info chart
    createChart(document.getElementById("pedigreeTypes").getContext('2d'), pedigreeTypes())
    // create cases detailed stats chart
    createChart(document.getElementById("cases-bar-horiz").getContext('2d'), casesDetailed())
    // create variants detailed stats chart
    createChart(document.getElementById("var-validations").getContext('2d'), varValidations())


    function createChart(ctx,chartData){
      //plots the chart
      new Chart(ctx, chartData);
    }

    function varValidations(){
      var dataSets = [];
      var maxValidations = 0;
      counter = 0
      {% for topic in variants %}
        if ('{{topic.title}}' === 'Validation ordered'){
          maxValidations = parseInt('{{topic.count}}');
        }
        else {
          percentValid = parseInt('{{topic.count}}');
          if(maxValidations > 0){
            percentValid = percentValid * 100 / maxValidations;
          }
          dataSets.push(percentValid);
        }
        counter++;
      {% endfor %}

      var myChart = {
        type: 'bar',
        data: {
          labels: ["Verifications"],
          datasets: [
            { //true positives
              label: 'Validated True Positive',
              data: [dataSets[0]],
              backgroundColor: '#46bfbd',
            },
            { //false positives
              label: 'Validated False Positive',
              data: [dataSets[1]],
              backgroundColor: '#f7464a',
            }
          ]
        },
        options: {
          scales: {
            xAxes: [{ stacked: true }],
            yAxes: [
              //{ stacked: true },
              { ticks: {
                  min: 0,
                  max: 100,
                  callback: function(value) {
                      return value + "%"
                  }
              }},
            ]
          },
          tooltips: {
            callbacks: {
              label: function(tooltipItem) {
                return '' + Number(tooltipItem.yLabel) * maxValidations / 100;
              }
            }
          }
        },
      };
      return myChart;
    }

    function casesDetailed(){
      var labels = [{% for topic in overview %} '{{topic.title}}', {% endfor %}];
      var bkg = []
      var hover = []
      labels.forEach(function (item, index) {
        bkg.push(bkgColors[index])
      });
      var chart_data = {
        type: 'horizontalBar',
        data: {
          labels: labels,
          datasets: [{
            data: [{% for topic in overview %} {{topic.count*100}}, {% endfor %}],
            backgroundColor: bkg,
            hoverBackgroundColor: hover
          }],
        },
        options: {
          scales: {
            xAxes: [{
                 ticks: {
                     min: 0,
                     max: 100,
                     callback: function(value) {
                         return value + "%"
                     }
                 },
                 scaleLabel: {
                     display: true,
                     labelString: "Percentage"
                 }
             }]
          },
          legend: {display: false}
        }
      };
      return chart_data;
    }

    function pedigreeTypes(){
      var labels = [{% for topic in pedigree %} '{{topic.title}}', {% endfor %}];
      var bkg = []
      var hover = []
      labels.forEach(function (item, index) {
        bkg.push(bkgColors[index]);
        hover.push(hoverColors[index]);
      });
      var chart_data = {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: [{% for topic in pedigree %} {{topic.count}}, {% endfor %}],
            backgroundColor: bkg,
            hoverBackgroundColor: hover
          }],
        },
      };
      return chart_data;
    }

    function casesType(){
      //creates data for the general cases stats chart
      // exclude stats for all samples (cases[1:])
      var labels = [{% for group in cases[1:] %} '{{group.status}}', {% endfor %}];
      var bkg = []
      var hover = []
      labels.forEach(function (item, index) {
        bkg.push(bkgColors[index])
        hover.push(hoverColors[index])
      });
      var chart_data = {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: [{% for group in cases[1:] %} {{group.count}}, {% endfor %}],
            backgroundColor: bkg,
            hoverBackgroundColor: hover
          }],
        },
      };
      return chart_data;
    }

    function analysisTypeData(){
      //creates data for the general samples (WGS/WES) stats chart
      var labels = [{% for group in analysis_types %} '{{group.name|upper}}', {% endfor %}];
      var colors = {
        'bkgColors' : {
          'WES' : '#46bfbd',
          'WGS' : '#fdb45c',
        },
        'hoverColors' : {
          'WES' : '#5ad3d1',
          'WGS' : '#ffc870',
        },
      };
      var bkg = []
      var hover = []
      for(var label of labels) {
        bkg.push(colors['bkgColors'][label]);
        hover.push(colors['hoverColors'][label]);
      }
      var chart_data = {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: [{% for group in analysis_types %} {{group.count}}, {% endfor %}],
            backgroundColor: bkg,
            hoverBackgroundColor: hover
          }],
        },
        options: {responsive: true}
      };
      return chart_data;
    }

    $(document).ready(function() {
      hide_div({{panel}})
    });

    function hide_div(show_div){
      for (i=1; i<4; i++) {
        var div_el = document.getElementById(i);
        if (i==show_div){ //show div
          div_el.style.display = "block";
        }
        else{ //hode other divs
          div_el.style.display = "none";
        }
      }
    }

    function update_select(admin_user){
      var query_text = document.getElementById("query").value;
      var sel = document.getElementById("institute");
      if(query_text && !admin_user) {
        sel.children[0].disabled = "disabled";
        if(sel.options[0].selected) {
          sel.options[0].selected = false;
          sel.options[1].selected = true;
        }
      }
      else{
        sel.children[0].disabled = "";
      }
    }
  </script>
{% endblock %}
